---
layout: post
title: How to make an Enterprisey API sexy
date: 2015-05-12 03:25:24.000000000 -05:00
type: post
published: true
status: publish
categories: []
tags: []
meta: {}
author:
  login: brycekbargar@gmail.com
  email: brycekbargar@gmail.com
  display_name: Bryce Bargar
  first_name: Bryce
  last_name: Bargar
---
<p>I'm all about writing sexy code. Unfortunately not everyone is.<br />A large part of the my last three jobs has been interfacing with "legacy" or "enterprisey" code.<br />So here are some of the things I've figured out for taking old things and making them maintainable, safe and easy to work with.</p>
<p>In this example I'll be paraphrasing a <a href="http://harmful.cat-v.org/software/xml/soap/simple">SOAP web service</a> I was asked to integrate with.</p>
<p><a target="_blank" href="https://github.com/brycekbargar/WorkingWithLegacyCode/tree/master/Integrations/BobsCrazyCycles/Client/Reference">I have done a "back of the envelope" approximation&nbsp;of the service here.</a>&nbsp;It has one service method that takes in a variety of requests. It's actually kind of cool because you can version and update individual requests without modifying the wrapping service. The rest of this post is going to have snippets referencing this repo.</p>
<p><strong>Reduce your exposure to the service as much as possible.</strong><br />Most of the time you just want to cherry pick an API's functionality. In our case we just want to buy the cheapest bike. We don't really care that you can buy tricycles. We certainly don't care that you can buy clown shoes. Listing prices is really secondary. We know we just want the cheapest.&nbsp;<br />This is easy to do explicitly</p>
<pre style="margin:0em; overflow:auto; background-color:#ffffff;"><code style="font-family:Consolas,&quot;Courier New&quot;,Courier,Monospace; font-size:10pt; color:#000000;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">interface</span> IBobsCrazyCyclesService
{
    PurchaseBicycleResponse BuyACheapBike();    
}</code></pre>
<p>It really is just that easy. Describe exactly what you want to use the service for, write unit tests around a mocked version, and then build out the implementation/integration tests to match.</p>
<p>There is one thing about this method that should stand out. Yes, we are returning a generated class.</p>
<p><strong>Congratuations! The response objects are now part of your domain.</strong><br />I waffled with this&nbsp;for years.&nbsp;Ok, maybe like 1...<br />But seriously, stop mapping POCO service response object to difference POCO domain objects. By returning the whole thing you let the user of the service determine what to do with the response. (BobsCrazyCycles&nbsp;is in the friggin name, it's not like you're hiding information by returning different domain models...)</p>
<p>I probably take this farther than most.</p>
<pre style="margin:0em; overflow:auto; background-color:#ffffff;"><code style="font-family:Consolas,&quot;Courier New&quot;,Courier,Monospace; font-size:10pt; color:#000000;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">partial</span> <span style="color:#0000ff;">class</span> ErrorResponse : Exception
{
    <span style="color:#0000ff;">public</span> ErrorResponse() : <span style="color:#0000ff;">base</span>(Message) { }
}</code></pre>
<p>Yeah. I went there. Most Code Gen tools create partial classes for this exact reason. So that you can extend them safely.<br />Throwing service responses helps you retain all the information in case of error. Every logging framework does a great job at logging exceptions. Not very many do well at logging arbitrary objects, especially if you want to have your logging 3-4 layer above where you get the original error response.<br />I've taken this (probably) insanely far. In the application I'm working on right now, I am literally pushing third party notifications into our Message Bus like they belong in our domain and handling them when we feel like it. It works.</p>
<p><strong>Use Factories and Client Wrappers</strong><br />How injectable/testable is our ServiceReference? Not at all. I don't even know what its base class is.<br />Does it manage it's resources? Probably? Yes. let's deploy some probablies to production...<br />This can all be solved by a ClientFactory and a Client Wrapper.</p>
<pre style="margin:0em; overflow:auto; background-color:#ffffff;"><code style="font-family:Consolas,&quot;Courier New&quot;,Courier,Monospace; font-size:10pt; color:#000000;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">interface</span> IBobsCrazyCyclesClientFactory
{
    IBobsCrazyCyclesClient Create();
}

<span style="color:#0000ff;">public</span> <span style="color:#0000ff;">interface</span> IBobsCrazyCyclesClient : IDisposable
{
    IBobsCrazyCyclesClientWithRequest Make&lt;TRequest&gt;(TRequest request);
}
    
<span style="color:#0000ff;">public</span> <span style="color:#0000ff;">interface</span> IBobsCrazyCyclesClientWithRequest
{
    TResponse AndGet&lt;TResponse&gt;();
}</code></pre>
<p>And</p>
<pre style="margin:0em; overflow:auto; background-color:#ffffff;"><code style="font-family:Consolas,&quot;Courier New&quot;,Courier,Monospace; font-size:10pt; color:#000000;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">class</span> BobsCrazyCyclesClientFactory : IBobsCrazyCyclesClientFactory
{
    <span style="color:#0000ff;">private</span> <span style="color:#0000ff;">readonly</span> BobsCrazyCyclesSettings _settings;
        
    <span style="color:#0000ff;">public</span> BobsCrazyCyclesClientFactory(BobsCrazyCyclesSettings settings)
    {
        _settings = settings;
    }
        
    <span style="color:#0000ff;">public</span> IBobsCrazyCyclesClient Create()
    {
        <span style="color:#0000ff;">var</span> credentials = <span style="color:#0000ff;">new</span> Credentials(_settings.Username, _settings.Password);
        <span style="color:#0000ff;">var</span> serviceReference = <span style="color:#0000ff;">new</span> ServiceReference(credentials, _settings.Endpoint);
            
        <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">new</span> BobsCrazyCyclesClient(serviceReference);
    }
}</code></pre>
<p>Notice how we only specify the service settings in one place? (also injectable)<br />Notice how the ClientWrapper is IDisposable allowing us to clean up after our Service Reference?<br />Simple. Clean. Maintainable.</p>
<p>Maybe you noticed something else. "IBobsCrazyCyclesClientWithRequest". Yes, we're getting really sexy now.</p>
<p><strong>Use Fluent Interfaces to Stitch Together Workflows</strong><br />One of the bigger headaches with legacy code is how many hoops you have to jump through to get anything done. Here you have to&nbsp;building the request object, create the client, make the request, handle the response in the good and error case. Plus these really aren't related and should be handled by different pieces of code.</p>
<p>"But Bryce!", you say, "<a href="http://ocramius.github.io/blog/fluent-interfaces-are-evil/">Fluent Interfaces are Evil</a>". And sometimes I agree. <a href="http://nest.azurewebsites.net/nest/writing-queries.html">NEST is one of the most god awful things I've worked with</a>. But we are really just building up a workflow here. First take my request, then give me a response. (ok, so part of the original reason I chose fluent interfaces is because I was bored. Another reason is that "public TResponse&nbsp;Get<span>&lt;TRequest, TResponse&gt;</span>(TRequest request)" is decidedly unsexy since <a href="http://programmers.stackexchange.com/questions/159754/why-the-question-give-five-things-you-hate-about-c-is-so-difficult-to-answer">c# doesn't have partial generic type inference...</a>)&nbsp;So here's the implementation.</p>
<pre style="margin:0em; overflow:auto; background-color:#ffffff;"><code style="font-family:Consolas,&quot;Courier New&quot;,Courier,Monospace; font-size:10pt; color:#000000;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">class</span> BobsCrazyCyclesClient : IBobsCrazyCyclesClient, IBobsCrazyCyclesClientWithRequest, IDisposable
{
    <span style="color:#0000ff;">private</span> <span style="color:#0000ff;">object</span> Request { <span style="color:#0000ff;">get</span>; <span style="color:#0000ff;">set</span>; }
    <span style="color:#0000ff;">private</span> <span style="color:#0000ff;">readonly</span> ServiceReference _serviceReference;
        
    <span style="color:#0000ff;">public</span> BobsCrazyCyclesClient(ServiceReference serviceReference)
    {
        _serviceReference = serviceReference;
    }
        
    IBobsCrazyCyclesClientWithRequest Make&lt;TRequest&gt;(TRequest request)
    {
        Request = request;
        <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">this</span>;
    }
        
    <span style="color:#0000ff;">public</span> TResponse AndGet&lt;TResponse&gt;()
    {
        <span style="color:#008000;">// I would refactor something here but I don't have ctrl +R +R...</span>
        <span style="color:#0000ff;">var</span> request = <span style="color:#0000ff;">new</span> Request
        {
            Request = Request
        };
        
        <span style="color:#0000ff;">var</span> response = _serviceReference.Send(request);
        <span style="color:#0000ff;">if</span>(response.Ack != <span style="color:#a31515;">"OK"</span>)
        {
            <span style="color:#0000ff;">throw</span> (ErrorResponse)response.Response;
        }
            
        <span style="color:#0000ff;">return</span> (TResponse)response.Response;
    }
        
    #region IDisposable
    #endregion
}</code></pre>
<p>Notice how all this does is&nbsp;make requests to the ServiceReference and handle the response? Single Responsibility.</p>
<p>Â </p>
<p>Putting this all together you end up with some decidedly sexy, testable and maintainable.</p>
<pre style="margin:0em; overflow:auto; background-color:#ffffff;"><code style="font-family:Consolas,&quot;Courier New&quot;,Courier,Monospace; font-size:10pt; color:#000000;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">class</span> BobsCrazyCyclesService : IBobsCrazyCyclesService
{
    <span style="color:#0000ff;">private</span> <span style="color:#0000ff;">readonly</span> IBobsCrazyCyclesCLientFactory _clientFactory;
        
    <span style="color:#0000ff;">public</span> BobsCrazyCyclesService(IBobsCrazyCyclesCLientFactory clientFactory)
    {
        _clientFactory = clientFactory;
    }
        
    PurchaseBicycleResponse BuyACheapBike()
    {
        <span style="color:#0000ff;">try</span>
        {
            <span style="color:#0000ff;">using</span>(<span style="color:#0000ff;">var</span> client = _clientFactory.Create())
            {
                <span style="color:#0000ff;">var</span> bicyclesForSale = 
                    client
                        .Make(<span style="color:#0000ff;">new</span> ListBicyclePriceRequest
                        {
                            Version = 3.14M
                        })
                        .AndGet&lt;ListBicyclePriceResponse&gt;();
                        
                <span style="color:#0000ff;">var</span> cheapestId = 
                    bicyclesForSale
                        .IdsAndPrices
                            .OrderBy(x =&gt; x.Value)
                            .Select(x =&gt; x.Key)
                            .FirstOrDefault();
                        
                <span style="color:#0000ff;">return</span>
                    client
                        .Make(<span style="color:#0000ff;">new</span> PurchaseBicycleRequest
                        {
                            Version = 777M,
                            Id = cheapestId
                        })
                        .AndGet&lt;PurchaseBicycleResponse&gt;(); 
            }
        }
        <span style="color:#0000ff;">catch</span>(ErrorResponse)
        {
            <span style="color:#008000;">// Do something because this response object is in our domain</span>
            <span style="color:#008000;">// Also it's pretty easy to the entire response because we have the whole thing!</span>
        }
    }
}</code></pre>
<p id="yui_3_17_2_3_1431189012673_34148"></p>
